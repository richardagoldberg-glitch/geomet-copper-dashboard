<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geomet — Copper Intelligence</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');
:root{--bg:#0a0e14;--sf:#111820;--sf2:#1a2230;--bd:#1e2a3a;--tx:#e0e6ed;--tm:#6b7f99;--td:#3d4f63;
--g:#00e59b;--gd:rgba(0,229,155,.12);--r:#ff4757;--rd:rgba(255,71,87,.12);
--y:#ffc048;--yd:rgba(255,192,72,.12);--o:#ff8c42;--od:rgba(255,140,66,.12);
--b:#4a9eff;--bdd:rgba(74,158,255,.12);--cu:#d4845a;--cg:rgba(212,132,90,.15);
--p:#a78bfa;--pd:rgba(167,139,250,.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans',-apple-system,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--bd);background:linear-gradient(180deg,rgba(212,132,90,.06) 0%,transparent 100%)}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{height:28px;display:flex;align-items:center}.logo img{height:100%;width:auto}
.hdr-t{font-size:13px;font-weight:300;color:var(--tm)}
.hdr-r{display:flex;align-items:center;gap:14px}
.ri{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--td)}
.sd{width:7px;height:7px;border-radius:50%;background:var(--g);animation:p 2s infinite}
@keyframes p{0%,100%{opacity:1}50%{opacity:.4}}
.ch-badge{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;padding:3px 7px;border-radius:3px;letter-spacing:0.5px}
.ch-badge.open{background:var(--gd);color:var(--g)}.ch-badge.closed{background:var(--rd);color:var(--r)}.ch-badge.warn{background:var(--yd);color:var(--y)}
.db{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:1px;background:var(--bd);margin:1px;align-items:start}
.pn{background:var(--sf);padding:20px 22px}
.pl{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--td);margin-bottom:14px;display:flex;align-items:center;gap:6px}
.pl::before{content:'';width:3px;height:10px;border-radius:1px}
.pp .pl::before{background:var(--cu)}.tp .pl::before{background:var(--b)}.sp .pl::before{background:var(--y)}
.posp .pl::before{background:var(--g)}.slp .pl::before{background:var(--p)}.sap .pl::before{background:var(--b)}
.dp .pl::before{background:var(--o)}.fwp .pl::before{background:var(--g)}
.pm{display:flex;align-items:baseline;gap:8px;margin-bottom:5px}
.pv{font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;line-height:1;letter-spacing:-1px}
.pu{font-size:11px;color:var(--td)}
.pc{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;padding:3px 7px;border-radius:3px}
.pc.up{color:var(--g);background:var(--gd)}.pc.dn{color:var(--r);background:var(--rd)}
.ps{font-size:11px;color:var(--td);margin-top:2px}
.lr{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;background:var(--sf2);border-radius:4px;margin-top:8px}
.ll{font-size:10px;color:var(--tm)}.lv{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}
.mc-wide{background:var(--sf2);border-radius:4px;padding:6px 10px;margin-top:4px}
.mc-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.mc-title{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;letter-spacing:.5px;color:var(--td)}
.mc-val{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700}
.mc-chart{height:48px}.mc-chart svg{width:100%;height:100%}
.mc-months{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--td);padding:2px 0 0}
.mc-ctx{display:flex;gap:6px;margin-top:4px}
.mc-ctx-item{flex:1;padding:5px 8px;background:var(--sf2);border-radius:4px;display:flex;justify-content:space-between;align-items:center}
.mc-ctx-l{font-size:9px;color:var(--tm)}.mc-ctx-v{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600}
.mg{display:grid;gap:7px}
.mr{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--sf2);border-radius:4px;border-left:3px solid transparent}
.mr.a{border-left-color:var(--g)}.mr.bl{border-left-color:var(--r)}
.ml{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tm)}
.mv{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600}
.ms{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.ms.a{color:var(--g)}.ms.bl{color:var(--r)}
.mt{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--td);padding:4px 7px;background:var(--sf2);border-radius:3px;display:inline-block}
.sb{display:inline-flex;padding:8px 14px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700;letter-spacing:1px;margin-bottom:10px}
.sb.green{background:var(--gd);color:var(--g);border:1px solid rgba(0,229,155,.25)}
.sb.red{background:var(--rd);color:var(--r);border:1px solid rgba(255,71,87,.25)}
.sb.yellow{background:var(--yd);color:var(--y);border:1px solid rgba(255,192,72,.25)}
.sb.orange{background:var(--od);color:var(--o);border:1px solid rgba(255,140,66,.25)}
.sb.blue{background:var(--bdd);color:var(--b);border:1px solid rgba(74,158,255,.25)}
.sdt{font-size:12px;color:var(--tm);line-height:1.4}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.pk{padding:9px 10px;background:var(--sf2);border-radius:4px}
.pkl{font-size:9px;color:var(--td);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.pkv{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700}
.pkv.pos{color:var(--g)}.pkv.neg{color:var(--r)}
.pks{font-size:9px;color:var(--td);margin-top:2px}
.rs{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bd)}.rs:last-child{border-bottom:none}
.rsl{font-size:11px;color:var(--tm)}.rsv{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}
.rbg{height:5px;background:var(--sf2);border-radius:3px;overflow:hidden;margin-top:5px}.rbf{height:100%;border-radius:3px}
.sbar{display:flex;height:18px;border-radius:3px;overflow:hidden;margin:6px 0}.sbp{background:var(--g)}.sbu{background:var(--p)}
.slg{display:flex;gap:10px;margin-top:4px;margin-bottom:10px}
.sli{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--tm)}
.sld{width:6px;height:6px;border-radius:2px}
.dl{display:grid;gap:7px}
.di{padding:9px 10px;background:var(--sf2);border-radius:4px;font-size:12px;line-height:1.4;border-left:3px solid var(--cu);display:flex;align-items:center;justify-content:space-between;gap:8px}
.di-txt{flex:1;min-width:0}
.di-jump{flex-shrink:0;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:4px;background:var(--bd);color:var(--tm);font-size:11px;cursor:pointer;transition:background .15s,color .15s}
.di-jump:hover{background:var(--cu);color:var(--tx)}
.di.warn{border-left-color:var(--r);background:rgba(255,71,87,.06)}
.di.fix-good{border-left-color:var(--g);background:rgba(0,229,155,.06)}
.di.fix-bad{border-left-color:var(--r);background:rgba(255,71,87,.06)}
.gi{padding:8px 10px;background:var(--sf2);border-radius:4px;margin-bottom:6px;border-left:3px solid transparent}
.gi.high{border-left-color:var(--g)}.gi.medium{border-left-color:var(--y)}.gi.low{border-left-color:var(--td)}
.ga{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1px;margin-bottom:3px}
.ga.high{color:var(--g)}.ga.medium{color:var(--y)}.ga.low{color:var(--tm)}
.gd{font-size:11px;color:var(--tm);line-height:1.3}
.gp-hdr{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;letter-spacing:1.5px;color:var(--td);margin:12px 0 8px;text-transform:uppercase}
.gp-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--sf2);border-radius:4px;margin-bottom:5px;border-left:3px solid var(--y)}
.gp-item.hit{border-left-color:var(--g);background:rgba(0,229,155,.08);animation:gp-pulse 1.5s ease-in-out infinite}
@keyframes gp-pulse{0%,100%{opacity:1}50%{opacity:.7}}
.gp-badge{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;letter-spacing:.5px;flex-shrink:0}
.gp-badge.active{background:var(--yd);color:var(--y)}.gp-badge.hit{background:var(--gd);color:var(--g)}
.gp-info{flex:1;min-width:0}
.gp-line1{font-size:11px;font-weight:600;color:var(--tx)}.gp-line2{font-size:10px;color:var(--tm);margin-top:2px}
.gp-dist{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;flex-shrink:0}
.gp-rm{width:18px;height:18px;display:flex;align-items:center;justify-content:center;border-radius:3px;background:transparent;border:1px solid var(--bd);color:var(--td);font-size:11px;cursor:pointer;flex-shrink:0;transition:all .15s}
.gp-rm:hover{background:var(--rd);border-color:var(--r);color:var(--r)}
.gp-add-btn{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tm);cursor:pointer;padding:4px 0;letter-spacing:.5px}
.gp-add-btn:hover{color:var(--tx)}
.gp-form{background:var(--sf2);border-radius:4px;padding:10px;margin-top:6px;display:none}
.gp-form.show{display:block}
.gp-form input,.gp-form select{background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:'JetBrains Mono',monospace;font-size:11px;padding:5px 8px;border-radius:3px;width:100%;margin-bottom:6px}
.gp-form-row{display:flex;gap:6px}
.gp-form-row input,.gp-form-row select{flex:1}
.gp-form-btns{display:flex;gap:6px;margin-top:4px}
.gp-form-btns button{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 12px;border-radius:3px;cursor:pointer;border:none}
.gp-form-btns .gp-save{background:var(--gd);color:var(--g)}.gp-form-btns .gp-cancel{background:var(--sf);color:var(--tm);border:1px solid var(--bd)}
.tl{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;background:rgba(0,229,155,.06);border:1px dashed rgba(0,229,155,.3);border-radius:4px;margin-bottom:10px}
.tll{font-size:10px;color:var(--g)}.tlv{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--g)}
.nd{color:var(--td);font-style:italic;font-size:11px;padding:12px 0}
.ld{display:flex;align-items:center;justify-content:center;min-height:200px;color:var(--td)}
.ls{width:16px;height:16px;border:2px solid var(--bd);border-top-color:var(--cu);border-radius:50%;animation:sp .8s linear infinite;margin-right:8px}
@keyframes sp{to{transform:rotate(360deg)}}
.s2{grid-column:span 2}
.pn.pp{order:1}.pn.posp{order:2}.pn.sp{order:3}.pn.slp{order:4}.pn.sap{order:5}.pn.tp{order:6}.pn.dp{order:7}
.cat-row{display:flex;justify-content:space-between;padding:6px 10px;background:var(--sf2);border-radius:4px;margin-bottom:4px;border-left:3px solid transparent}
.cat-row.hot{border-left-color:var(--r);background:rgba(255,71,87,.06)}.cat-row.ok{border-left-color:var(--g)}.cat-row.chill{border-left-color:var(--td)}
.cat-label{font-size:10px;color:var(--tm)}.cat-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600}
.cat-val.hot{color:var(--r)}.cat-val.ok{color:var(--g)}.cat-val.chill{color:var(--tm)}
.arb-box{padding:10px;background:var(--sf2);border-radius:5px;border-left:3px solid var(--b);margin-top:10px}
.arb-dir{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;color:var(--b);margin-bottom:4px}
.arb-msg{font-size:11px;color:var(--tm);line-height:1.3}
.ctx-row{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--sf2);border-radius:4px;margin-bottom:5px}
.ctx-l{font-size:10px;color:var(--tm)}.ctx-v{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600}
.rng-bar{height:8px;background:var(--sf2);border-radius:4px;position:relative;margin:6px 0}
.rng-fill{position:absolute;height:100%;border-radius:4px;background:linear-gradient(90deg,var(--r),var(--y),var(--g));opacity:.3}
.rng-dot{position:absolute;top:-2px;width:4px;height:12px;background:var(--tx);border-radius:2px;transform:translateX(-50%)}
.rng-labels{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--td)}
.roc-row{display:flex;align-items:center;gap:6px;padding:4px 10px;background:var(--sf2);border-radius:4px;margin-bottom:4px}
.roc-label{font-size:9px;color:var(--td);width:28px}
.roc-bar-wrap{flex:1;height:6px;background:var(--bd);border-radius:3px;position:relative;overflow:visible}
.roc-bar{height:100%;border-radius:3px;position:absolute;top:0}
.roc-val{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;width:70px;text-align:right}
.streak-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;margin-top:6px}
.streak-badge.up{background:var(--gd);color:var(--g)}.streak-badge.down{background:var(--rd);color:var(--r)}
.sr-row{display:flex;justify-content:space-between;padding:5px 10px;background:var(--sf2);border-radius:4px;margin-bottom:4px;border-left:3px solid transparent}
.sr-row.sup{border-left-color:var(--g)}.sr-row.res{border-left-color:var(--r)}
.sr-level{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600}
.sr-dist{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--td)}
.fw-meter{padding:12px;background:var(--sf2);border-radius:6px;margin-bottom:12px}
.fw-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.fw-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;letter-spacing:1px}
.fw-score{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700}
.fw-bar{height:8px;background:var(--bd);border-radius:4px;overflow:hidden;margin-bottom:6px}
.fw-fill{height:100%;border-radius:4px;transition:width .5s}
.fw-factors{display:flex;flex-wrap:wrap;gap:4px}
.fw-tag{font-size:9px;padding:2px 6px;border-radius:3px;background:var(--sf);color:var(--tm);border:1px solid var(--bd)}
.so-section{margin-top:8px;padding:6px 0;border-top:1px solid var(--bd)}
.so-hdr{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;letter-spacing:1px;margin-bottom:5px;padding:0 2px}
.so-hdr.ship{color:var(--r)}.so-hdr.unship{color:var(--p)}
.so-scroll{max-height:240px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.so-scroll::-webkit-scrollbar{width:4px}.so-scroll::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
.so-row{display:flex;align-items:center;gap:4px;padding:5px 8px;background:var(--sf2);border-radius:4px;margin-bottom:3px;font-size:10px;border-left:3px solid transparent;min-width:0}
.so-row.shipped{border-left-color:var(--r);background:rgba(255,71,87,.06)}.so-row.unshipped{border-left-color:var(--p);background:rgba(167,139,250,.06)}
.so-cust{flex:1;color:var(--tx);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.so-comm{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tm);width:40px;text-align:center;flex-shrink:0}
.so-lbs{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;width:52px;text-align:right;flex-shrink:0}
.so-basis{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600;padding:1px 4px;border-radius:2px;letter-spacing:.5px;flex-shrink:0;white-space:nowrap}
.so-basis.comex{background:var(--cg);color:var(--cu)}.so-basis.lme{background:var(--bdd);color:var(--b)}
.so-avail{flex-shrink:0;font-size:8px;width:12px;text-align:center}
.so-avail.live{color:var(--g)}.so-avail.off{color:var(--td)}
.fw-context{padding:8px 10px;background:var(--sf2);border-radius:4px;margin-top:8px;font-size:10px;color:var(--tm)}
.fw-nudge{padding:8px 10px;background:rgba(0,229,155,.08);border:1px dashed rgba(0,229,155,.3);border-radius:4px;margin-top:6px;font-size:10px;color:var(--g);font-weight:500}
.arb-tag{display:inline-flex;align-items:center;gap:3px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;letter-spacing:.5px;padding:2px 6px;border-radius:3px;margin-left:6px}
.arb-tag.arb{background:rgba(255,192,72,.15);color:var(--y);border:1px solid rgba(255,192,72,.3)}
.arb-tag.parity{background:var(--sf2);color:var(--tm);border:1px solid var(--bd)}
@media(max-width:1400px){.db{grid-template-columns:1fr 1fr 1fr}.s2{grid-column:span 1}}
@media(max-width:1000px){.db{grid-template-columns:1fr 1fr}}
@media(max-width:700px){
.db{grid-template-columns:1fr;gap:0}
.s2{grid-column:span 1}
/* Mobile panel order — most actionable first */
.pn.pp{order:1} /* Trading */
.pn.posp{order:2} /* Position */
.pn.sp{order:3} /* Signal & GTC */
.pn.slp{order:4} /* Sales Orders */
.pn.sap{order:5} /* Sales & Margin */
.pn.tp{order:6} /* Market */
.pn.dp{order:7} /* What To Do */
/* Compact spacing */
.pn{padding:14px 16px}
.pl{margin-bottom:10px;font-size:8px}
.pv{font-size:28px}
.pc{font-size:11px}
.hdr{padding:10px 16px;flex-wrap:wrap;gap:8px}
.hdr-t{font-size:11px}
.hdr-r{gap:8px;flex-wrap:wrap}
.ch-badge{font-size:8px;padding:2px 5px}
.ri{font-size:9px}
/* Charts taller on mobile for thumb readability */
.mc-chart{height:56px}
/* Fix window */
.fw-meter{padding:10px}
.fw-score{font-size:18px}
/* Sales order rows */
.so-row{padding:6px 8px;font-size:10px}
.so-scroll{max-height:200px}
/* Position grid */
.pg{grid-template-columns:1fr 1fr;gap:5px}
.pk{padding:7px 8px}
.pkv{font-size:13px}
/* Broker Intel */
.intel-wrap{padding:8px 10px;border-bottom:1px solid var(--bd)}
.intel-toggle{background:none;border:1px solid var(--bd);border-radius:4px;padding:4px 10px;font-size:10px;
color:var(--tm);cursor:pointer;font-family:'JetBrains Mono',monospace;letter-spacing:.5px;font-weight:600}
.intel-toggle:hover{background:var(--sf2)}
.intel-toggle.has-intel{color:var(--y);border-color:var(--y)}
.intel-form{display:none;margin-top:8px}
.intel-form.open{display:block}
.intel-ta{width:100%;background:var(--sf);border:1px solid var(--bd);border-radius:6px;padding:8px;
color:var(--tx);font-size:11px;font-family:inherit;resize:vertical;min-height:60px;outline:none}
.intel-ta:focus{border-color:var(--cu)}
.intel-btns{display:flex;gap:6px;margin-top:6px}
.intel-btn{padding:4px 12px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;border:none;font-family:inherit}
.intel-save{background:var(--cu);color:#fff}
.intel-clear{background:var(--sf2);color:var(--tm)}
.intel-signals{margin-top:6px;font-size:10px}
.intel-sig{padding:3px 0;color:var(--tm)}
.intel-sig.bull{color:var(--g)}
.intel-sig.bear{color:var(--r)}
.intel-sig.watch{color:var(--y)}
.intel-time{font-size:9px;color:var(--td);margin-top:4px}
.intel-detail{padding-left:16px;font-size:10px;opacity:0.85;border-left:2px solid var(--bd);margin-left:4px;display:none}
.intel-head{cursor:pointer}.intel-head .di-txt::after{content:' ▸';font-size:9px;opacity:0.5}
.intel-head.open .di-txt::after{content:' ▾'}
.intel-head.open+.intel-detail,.intel-head.open+.intel-detail+.intel-detail{display:block}
/* Ship Schedule */
.sh-wrap{margin-top:8px;border-top:1px solid var(--bd);padding-top:8px}
.sh-hdr{font-size:10px;font-weight:700;color:var(--cu);margin-bottom:6px;letter-spacing:.3px}
.sh-tbl{width:100%;font-size:10px;border-collapse:collapse}
.sh-tbl th{text-align:left;color:var(--td);font-weight:600;padding:2px 4px;border-bottom:1px solid var(--bd);font-size:9px}
.sh-tbl td{padding:3px 4px;border-bottom:1px solid var(--sf2)}
.sh-tbl tr.sh-urgent td{color:var(--r);font-weight:600}
.sh-tbl tr.sh-soon td{color:var(--y)}
.sh-tbl .sh-so{font-family:'JetBrains Mono',monospace;font-size:9px}
.sh-tbl .sh-cust{max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
/* Decisions */
.dec-sec{padding:6px 10px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
color:var(--td);border-bottom:1px solid var(--bd);border-top:1px solid var(--bd);background:var(--sf)}
.dec-sec.sec-now{color:var(--cu);background:rgba(224,128,51,0.08)}
.dec-sec.sec-watch{color:var(--y)}
.dec-sec.sec-ref{color:var(--td);opacity:0.7}
.di{padding:8px 10px;font-size:11px}
/* Context row stack on narrow */
.mc-ctx{flex-direction:column;gap:4px}
/* Arb box */
.arb-box{padding:8px}
.arb-msg{font-size:10px}
}
body.light{--bg:#f0f2f5;--sf:#ffffff;--sf2:#e8ecf1;--bd:#d0d7e0;--tx:#1a1e24;--tm:#5a6577;--td:#8494a7;
--g:#00a86b;--gd:rgba(0,168,107,.12);--r:#d63447;--rd:rgba(214,52,71,.12);
--y:#c99000;--yd:rgba(201,144,0,.12);--o:#cc6a2a;--od:rgba(204,106,42,.12);
--b:#2b7de9;--bdd:rgba(43,125,233,.12);--cu:#a96840;--cg:rgba(169,104,64,.15);
--p:#7c5cbf;--pd:rgba(124,92,191,.12)}
.theme-btn{background:none;border:1px solid var(--bd);border-radius:4px;cursor:pointer;padding:3px 8px;font-size:14px;line-height:1;color:var(--tm)}
.theme-btn:hover{background:var(--sf2)}
</style>
</head>
<body>
<div class="hdr"><div class="hdr-l"><div class="logo"><img src="/logo.png" alt="Geomet"></div><div class="hdr-t">Copper Intelligence Dashboard</div></div>
<div class="hdr-r"><div id="cmx" class="ch-badge closed" style="display:none"></div><div id="lme" class="ch-badge closed"></div><div id="ch" class="ch-badge closed"></div><div id="si" class="ri"></div><div class="ri" id="ri">Loading...</div><button id="thm" class="theme-btn" onclick="toggleTheme()" title="Toggle light/dark mode"></button><div class="sd" id="sd"></div></div></div>
<div class="db" id="db"><div class="ld"><div class="ls"></div>Fetching copper data...</div></div>
<script>
function applyTheme(t){if(t==='light')document.body.classList.add('light');else document.body.classList.remove('light');var b=document.getElementById('thm');if(b)b.textContent=t==='light'?'\u2600\uFE0F':'\uD83C\uDF19'}
(function(){var t=localStorage.getItem('cu-theme');if(t)applyTheme(t);fetch('/api/theme').then(function(r){return r.json()}).then(function(d){applyTheme(d.theme);localStorage.setItem('cu-theme',d.theme)}).catch(function(){})})();
function toggleTheme(){var l=!document.body.classList.contains('light');var t=l?'light':'dark';applyTheme(t);localStorage.setItem('cu-theme',t);fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({theme:t})}).catch(function(){})}
function syncTheme(){fetch('/api/theme').then(function(r){return r.json()}).then(function(d){applyTheme(d.theme);localStorage.setItem('cu-theme',d.theme)}).catch(function(){})}
// Broker Intel
window._intelData=null;
function loadIntel(){fetch('/api/intel').then(function(r){return r.json()}).then(function(d){if(d&&d.date)window._intelData=d;else window._intelData=null}).catch(function(){})}
loadIntel();
function toggleIntel(){var f=document.getElementById('intel-form');if(f)f.classList.toggle('open')}
function saveIntel(){var ta=document.getElementById('intel-ta');if(!ta)return;var text=ta.value.trim();if(!text)return;
fetch('/api/intel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text})}).then(function(r){return r.json()}).then(function(d){window._intelData=d;fd()}).catch(function(){})}
function clearIntel(){fetch('/api/intel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:''})}).then(function(){window._intelData=null;fd()}).catch(function(){})}
function n(v){return v?Number(v).toLocaleString():'0'}
function $(id){return document.getElementById(id)}
async function fd(){try{var r=await fetch('/api/data');var d=await r.json();render(d);checkGtcAlerts(d.gtc_placed||[]);$('sd').style.background='var(--g)'}catch(e){$('sd').style.background='var(--r)';$('ri').textContent='Connection error'}}
function render(d){
var m=d.market,s=d.signals,pos=d.position,r=d.position_risk,dec=d.decisions,gtc=d.gtc_suggestions||[],gtp=d.gtc_placed||[],cfg=d.config||{},fw=d.fix_window,fo=d.fixable_orders,sched=d.ship_schedule||[];
$('ri').textContent='Updated '+d.last_refresh;
if(pos&&pos.source_file)$('si').textContent='Source: '+pos.source_file;
if(m&&m.china){var ch=m.china,chc=ch.status==='OPEN'?'open':ch.thin_liquidity?'warn':'closed';
$('ch').className='ch-badge '+chc;$('ch').textContent=ch.status==='OPEN'?'SHFE OPEN':ch.detail;}
if(m&&m.lme){var lm=m.lme,lmc=lm.status==='CLOSED'?'warn':lm.session==='ring'?'open':'open';
$('lme').className='ch-badge '+lmc;$('lme').textContent=lm.detail;
if(lm.session==='ring')$('lme').style.fontWeight='800';else $('lme').style.fontWeight='';}
if(m&&m.comex){var cmx=m.comex,cmxEl=$('cmx');
if(cmx.status==='CLOSED'){cmxEl.style.display='';cmxEl.className='ch-badge closed';cmxEl.textContent=cmx.detail;}
else{cmxEl.style.display='none';}}
if(!m||!s){$('db').innerHTML='<div class="ld">Unable to fetch data.</div>';return}
var cc=m.change>=0?'up':'dn',cs=m.change>=0?'+':'',h='',cr=d.contract_roll;
var ac=m.active_contract||'front'; // which contract the big price represents
// COMEX Price Panel — consolidated prices
// Show the active contract ticker in the header
var acLabel='HG';
if(cr){if(ac==='next'&&cr.next_month)acLabel=cr.next_month.ticker+' ('+cr.next_month.label+')';
else acLabel=cr.front_month.ticker+' ('+cr.front_month.label+')';}
h+='<div class="pn pp" id="pn-pp"><div class="pl">COMEX Copper \u2014 '+acLabel+'</div><div class="pm"><div class="pv">'+m.price.toFixed(4)+'</div><div class="pu">$/lb</div>';
h+='<div class="pc '+cc+'">'+cs+m.change.toFixed(4)+' ('+cs+m.change_pct.toFixed(2)+'%)</div></div>';
h+='<div class="ps">Prev settle: '+m.prev_close.toFixed(4)+(m.copper_source?' <span style="font-size:8px;color:var(--td)">via '+m.copper_source+'</span>':'')+'</div>';
// Contango/backwardation — single clean line
if(cr&&cr.calendar_spread!==undefined&&cr.calendar_spread!==null){var fm=cr.front_month,nm=cr.next_month;
var ms=cr.market_structure;
var sclr=ms==='contango'?'var(--y)':ms==='backwardation'?'var(--b)':'var(--tm)';
var slbl=ms==='contango'?'CONTANGO':ms==='backwardation'?'BACKWARDATION':'FLAT';
var mRef=fm.label.split(' ')[0]+' \u2192 '+(nm?nm.label.split(' ')[0]:'');
h+='<div class="lr"><span class="ll">'+mRef+'</span><span class="lv" style="color:'+sclr+'">'+(cr.calendar_spread>=0?'+':'')+cr.calendar_spread.toFixed(4)+' <span style="font-size:9px;font-weight:600;letter-spacing:1px">'+slbl+'</span></span></div>';}
// LME section
h+='<div style="border-top:1px solid var(--bd);margin:8px 0"></div>';
if(m.lme_price_lb){
h+='<div style="display:flex;align-items:baseline;gap:8px;padding:8px 10px;background:var(--sf2);border-radius:4px"><span style="font-size:10px;color:var(--tm)">LME 3M</span><span style="font-family:JetBrains Mono,monospace;font-size:22px;font-weight:700">$'+m.lme_price_lb.toFixed(4)+'</span><span style="font-size:10px;color:var(--td)">/lb</span>';
if(m.lme_change!==null&&m.lme_change!==undefined){var lcc=m.lme_change>=0?'up':'dn',lcs=m.lme_change>=0?'+':'';h+='<span class="pc '+lcc+'" style="font-size:10px;padding:2px 5px">'+lcs+m.lme_change.toFixed(4)+' ('+lcs+m.lme_change_pct.toFixed(2)+'%)</span>';}
h+='</div>';
if(m.lme_cash_lb&&m.lme_price_mt){var csmt=m.lme_cash_3m_spread_mt;
h+='<div class="lr"><span class="ll">Cash \u2192 3M</span><span class="lv" style="color:var(--y)">+$'+csmt+'/MT CONTANGO <span style="font-size:9px;color:var(--td)">($'+n(Math.round(m.lme_price_mt))+'/MT)</span></span></div>';
}else if(m.lme_price_mt){h+='<div class="lr"><span class="ll">LME 3M</span><span class="lv">$'+n(Math.round(m.lme_price_mt))+'/MT</span></div>';}
if(m.comex_lme_spread!==null&&m.comex_lme_spread!==undefined){var spc=m.comex_lme_spread>=0?'var(--g)':'var(--b)';
var absSp=Math.abs(m.comex_lme_spread),spTag='';
if(absSp<0.05)spTag='<span class="arb-tag parity">PARITY</span>';
else if(absSp>=0.15)spTag='<span class="arb-tag arb">ARB</span>';
h+='<div class="lr"><span class="ll">COMEX \u2194 LME</span><span class="lv" style="color:'+spc+'">'+(m.comex_lme_spread>=0?'+':'')+m.comex_lme_spread.toFixed(4)+'/lb'+spTag+'</span></div>';}
h+='<div style="text-align:right;font-size:8px;color:var(--td);margin-top:3px">via '+m.lme_source+'</div>';
}else{h+='<div class="lr"><span class="ll">LME</span><span style="font-size:9px;color:var(--r)">Not configured</span></div>';}
// Chart — COMEX + LME overlay
h+='<div class="mc-wide"><div class="mc-hdr"><span class="mc-title">COMEX <span style="color:#d4845a">\u2501</span> &nbsp;LME <span style="color:#4a9eff">\u2504</span></span><span class="mc-val"><span id="mc-cx-v"></span> <span id="mc-lm-v" style="margin-left:6px"></span></span></div><div class="mc-chart" id="mc-overlay" style="height:64px"></div><div class="mc-months" id="mc-cx-m"></div></div>';
// Context row — DXY + Warehouse + Fed
h+='<div class="mc-ctx">';
if(m.dxy&&m.dxy.price){var dxc=m.dxy.change>=0?'var(--r)':'var(--g)';
h+='<div class="mc-ctx-item"><span class="mc-ctx-l">DXY</span><span class="mc-ctx-v" style="color:'+dxc+'">'+m.dxy.price+' <span style="font-size:8px">'+(m.dxy.change>=0?'+':'')+m.dxy.change+'</span></span></div>';}
if(m.warehouse&&m.warehouse.mt){var wh=m.warehouse;
var wa=wh.trend==='building'?'\u2191':wh.trend==='drawing'?'\u2193':'\u2192';
var wc=wh.trend==='building'?'var(--r)':wh.trend==='drawing'?'var(--g)':'var(--tm)';
var whTot=wh.global_mt?n(wh.global_mt)+' MT':n(wh.mt)+' MT';
h+='<div class="mc-ctx-item"><span class="mc-ctx-l">Warehouse</span><span class="mc-ctx-v" style="color:'+wc+'">'+whTot+' '+wa+'</span></div>';}
if(m.fed){var fed=m.fed;
h+='<div class="mc-ctx-item"><span class="mc-ctx-l">Fed</span><span class="mc-ctx-v">'+fed.current_rate+'%</span></div>';}
h+='</div>';
h+='</div>';
// Position — consolidated: Morning Report + Position + Risk
h+='<div class="pn posp" id="pn-posp"><div class="pl">Position</div>';
if(r&&r.total_inv_po>0){
var unprShip=r.sales_unpriced_shipped_lbs||0;
var invPo=r.total_inv_po;
var pricedUn=r.sales_priced_unshipped_lbs||0;
var noPriceLbs=invPo-pricedUn;
var hedgeLots=pos?(Math.round((pos.comex_futures||0)/25000)+Math.round((pos.lme_futures||0)/25000)):0;
var hedgeLbs=pos?((pos.comex_futures||0)+(pos.lme_futures||0)):0;
var bal=noPriceLbs-hedgeLbs;
var balClr=bal>0?'var(--r)':'var(--g)',balLbl=bal>0?'LONG':'SHORT';
h+='<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:4px"><span style="font-family:JetBrains Mono,monospace;font-size:28px;font-weight:700;color:'+balClr+'">'+n(Math.abs(Math.round(bal)))+'</span><span style="font-size:11px;color:var(--td)">lbs</span></div>';
h+='<div style="font-family:JetBrains Mono,monospace;font-size:10px;font-weight:700;letter-spacing:1px;color:'+balClr+';margin-bottom:12px">UNPRICED '+balLbl+'</div>';
h+='<div style="font-size:10px;line-height:1.6">';
h+='<div style="display:flex;justify-content:space-between;color:var(--tm)"><span>Inv <span style="color:var(--td)">'+n(Math.round(r.inventory_cu_lbs))+'</span> + PO <span style="color:var(--td)">'+n(Math.round(r.po_lbs))+'</span>'+(unprShip>0?' + Ship <span style="color:var(--td)">'+n(Math.round(unprShip))+'</span>':'')+'</span><span style="font-family:JetBrains Mono,monospace;font-weight:700;color:var(--cu)">'+n(Math.round(invPo))+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;color:var(--tm)"><span>\u2212 Priced SO</span><span style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--g)">'+n(Math.round(pricedUn))+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:3px 0;border-top:1px solid var(--bd);color:var(--tm)"><span>= Unpriced Exposure</span><span style="font-family:JetBrains Mono,monospace;font-weight:700;color:var(--p)">'+n(Math.round(noPriceLbs))+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;color:var(--tm)"><span>Hedge</span><span style="font-family:JetBrains Mono,monospace;font-weight:600">'+hedgeLots+' lots / '+n(Math.round(hedgeLbs))+' lbs</span></div>';
h+='</div>';
if(pos&&pos.source_file)h+='<div class="pks" style="margin-top:6px">Source: '+pos.source_file+(pos.updated?' \u2014 '+pos.updated:'')+'</div>';
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
var mc=r.mtm_pl>=0?'pos':'neg';
h+='<div class="pg"><div class="pk"><div class="pkl">Avg Cost</div><div class="pkv">$'+r.avg_cost.toFixed(4)+'</div></div>';
h+='<div class="pk"><div class="pkl">Hedged</div><div class="pkv">'+r.hedge_pct+'%</div></div>';
h+='<div class="pk"><div class="pkl">Mark-to-Market</div><div class="pkv '+mc+'">$'+n(Math.round(r.mtm_pl))+'</div></div>';
h+='<div class="pk"><div class="pkl">Per 10c Move</div><div class="pkv" style="color:'+(Math.abs(r.risk_per_dime)>10000?'var(--r)':'var(--tx)')+'">$'+n(Math.round(Math.abs(r.risk_per_dime)))+'</div></div></div>';
if(r.baseline_deviation!==undefined&&r.baseline_deviation!==null){var bd=r.baseline_deviation,abd=Math.abs(bd),bl=r.baseline_lbs,tl=cfg.truckload_lbs||42000;
var bclr=abd<=tl?'var(--g)':abd<=tl*3?'var(--tx)':'var(--r)';
var bdir=bd>0?'over':bd<0?'under':'on target';
var btxt=bd===0?'On target':'<span style="font-family:JetBrains Mono,monospace;font-weight:700;color:'+bclr+'">'+(bd>0?'+':'')+n(Math.round(bd))+' '+bdir+'</span>';
h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--sf2);border-radius:4px;margin-top:8px;border-left:3px solid '+bclr+'"><span style="font-size:10px;color:var(--tm)">vs Baseline ('+n(bl)+')</span>'+btxt+'</div>';}
var hp=Math.min(r.hedge_pct,100),hbc=hp>70?'var(--g)':hp>30?'var(--y)':'var(--r)';
h+='<div style="margin-top:8px"><div style="display:flex;justify-content:space-between;font-size:10px"><span style="color:var(--tm)">Hedge Coverage</span><span style="font-family:JetBrains Mono,monospace;font-weight:600">'+r.hedge_pct+'%</span></div>';
h+='<div class="rbg"><div class="rbf" style="width:'+hp+'%;background:'+hbc+'"></div></div></div>';
h+='<div class="rs"><span class="rsl">Unhedged</span><span class="rsv">'+n(Math.round(r.unhedged_lbs))+' lbs</span></div>';
}else h+='<div class="nd">Drop Hedge xlsx into data/</div>';
h+='</div>';
// Market — consolidated: Trend + Price Context + Contract Roll
h+='<div class="pn tp" id="pn-tp"><div class="pl">Market</div><div class="mg">';
[['50 DMA',m.ma50,s.above_50],['100 DMA',m.ma100,s.above_100],['200 DMA',m.ma200,s.above_200]].forEach(function(x){
h+='<div class="mr '+(x[2]?'a':'bl')+'"><span class="ml">'+x[0]+'</span><span class="mv">'+x[1].toFixed(4)+'</span><span class="ms '+(x[2]?'a':'bl')+'">'+(x[2]?'ABOVE':'BELOW')+'</span></div>';});
h+='</div><div style="margin-top:10px"><div class="mt">'+s.trend+' ('+s.trend_strength+')</div> <div class="mt" style="margin-left:3px">'+s.move_type+'</div></div>';
if(m.support_resistance){var sr=m.support_resistance;
var hasNear=(sr.near_resistance&&sr.near_resistance.length)||(sr.near_support&&sr.near_support.length);
var hasMajor=(sr.resistance&&sr.resistance.length)||(sr.support&&sr.support.length);
if(hasNear||hasMajor){
h+='<div style="margin-top:10px">';
if(hasNear){
h+='<div style="font-size:9px;color:var(--td);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px">Near-Term Levels <span style="opacity:0.6">(20d)</span></div>';
if(sr.near_resistance)sr.near_resistance.slice().reverse().forEach(function(r){h+='<div class="sr-row res"><span class="sr-level" style="color:var(--r)">'+r.level.toFixed(2)+' R</span><span class="sr-dist">'+(r.distance*100).toFixed(0)+'c above</span></div>';});
h+='<div class="sr-row" style="border-left-color:var(--cu);background:var(--cg)"><span class="sr-level" style="color:var(--cu)">'+m.price.toFixed(2)+' \u2190 NOW</span><span class="sr-dist"></span></div>';
if(sr.near_support)sr.near_support.forEach(function(s){h+='<div class="sr-row sup"><span class="sr-level" style="color:var(--g)">'+s.level.toFixed(2)+' S</span><span class="sr-dist">'+(s.distance*100).toFixed(0)+'c below</span></div>';});
}
if(hasMajor){
h+='<div style="font-size:9px;color:var(--td);margin:8px 0 5px;text-transform:uppercase;letter-spacing:1px">Major Levels <span style="opacity:0.6">(90d)</span></div>';
if(sr.resistance)sr.resistance.slice().reverse().forEach(function(r){h+='<div class="sr-row res"><span class="sr-level" style="color:var(--r)">'+r.level.toFixed(2)+' R</span><span class="sr-dist">'+(r.distance*100).toFixed(0)+'c above</span></div>';});
if(!hasNear)h+='<div class="sr-row" style="border-left-color:var(--cu);background:var(--cg)"><span class="sr-level" style="color:var(--cu)">'+m.price.toFixed(2)+' \u2190 NOW</span><span class="sr-dist"></span></div>';
if(sr.support)sr.support.forEach(function(s){h+='<div class="sr-row sup"><span class="sr-level" style="color:var(--g)">'+s.level.toFixed(2)+' S</span><span class="sr-dist">'+(s.distance*100).toFixed(0)+'c below</span></div>';});
}
h+='</div>';}}
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
if(m.range_90d){var r90l=m.range_90d[0],r90h=m.range_90d[1],r90r=r90h-r90l;
var ppos=r90r>0?((m.price-r90l)/r90r*100):50;
h+='<div class="ctx-l" style="margin-bottom:2px">90-Day Range</div>';
h+='<div class="rng-bar"><div class="rng-fill" style="width:100%"></div><div class="rng-dot" style="left:'+ppos+'%"></div></div>';
h+='<div class="rng-labels"><span>'+r90l.toFixed(2)+'</span><span>'+r90h.toFixed(2)+'</span></div>';}
h+='<div style="margin-top:8px">';
if(m.pct_30d!==undefined)h+='<div class="ctx-row"><span class="ctx-l">30-Day Percentile</span><span class="ctx-v" style="color:'+(m.pct_30d>75?'var(--g)':m.pct_30d<25?'var(--r)':'var(--tx)')+'">'+m.pct_30d+'th</span></div>';
if(m.pct_90d!==undefined)h+='<div class="ctx-row"><span class="ctx-l">90-Day Percentile</span><span class="ctx-v" style="color:'+(m.pct_90d>75?'var(--g)':m.pct_90d<25?'var(--r)':'var(--tx)')+'">'+m.pct_90d+'th</span></div>';
h+='</div>';
if(m.roc){h+='<div style="margin-top:8px"><div class="ctx-l" style="margin-bottom:5px">Momentum</div>';
['1d','3d','5d','10d'].forEach(function(k){if(!m.roc[k])return;var v=m.roc[k];
var clr=v.change>=0?'var(--g)':'var(--r)';var w=Math.min(Math.abs(v.pct)*10,50);
h+='<div class="roc-row"><span class="roc-label">'+k+'</span><div class="roc-bar-wrap"><div class="roc-bar" style="width:'+w+'%;background:'+clr+';'+(v.change<0?'right:50%;':'left:50%')+'"></div></div>';
h+='<span class="roc-val" style="color:'+clr+'">'+(v.change>=0?'+':'')+v.change.toFixed(2)+' ('+v.pct+'%)</span></div>';});
h+='</div>';}
if(m.streak&&m.streak>=2){h+='<div class="streak-badge '+(m.streak_dir||'up')+'">'+(m.streak_dir==='up'?'\u25B2':'\u25BC')+' '+m.streak+' day streak</div>';}
if(m.avg_daily_range){h+='<div class="ctx-row" style="margin-top:6px"><span class="ctx-l">Avg Daily Range (10d)</span><span class="ctx-v">'+m.avg_daily_range.toFixed(2)+'c</span></div>';
if(m.vol_vs_avg)h+='<div class="ctx-row"><span class="ctx-l">Today vs Avg Range</span><span class="ctx-v" style="color:'+(m.vol_vs_avg>1.5?'var(--y)':'var(--tx)')+'">'+m.vol_vs_avg.toFixed(1)+'x</span></div>';}
if(m.volume!==null&&m.volume!==undefined){var vBadge='';
if(m.vol_ratio>2)vBadge='<span style="font-family:JetBrains Mono,monospace;font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:var(--yd);color:var(--y);margin-left:6px">HIGH VOL</span>';
else if(m.vol_ratio<0.5)vBadge='<span style="font-family:JetBrains Mono,monospace;font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:var(--od);color:var(--o);margin-left:6px">THIN</span>';
h+='<div class="ctx-row" style="margin-top:6px"><span class="ctx-l">Volume'+vBadge+'</span><span class="ctx-v">'+n(m.volume)+' contracts</span></div>';
h+='<div class="ctx-row"><span class="ctx-l">20d Avg Volume</span><span class="ctx-v">'+n(m.avg_volume)+'</span></div>';
h+='<div class="ctx-row"><span class="ctx-l">Vol Ratio</span><span class="ctx-v" style="color:'+(m.vol_ratio>2?'var(--y)':m.vol_ratio<0.5?'var(--o)':'var(--tx)')+'">'+m.vol_ratio.toFixed(1)+'x</span></div>';}
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
var cot=d.cot;
if(cot){h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><span style="font-size:9px;color:var(--td);text-transform:uppercase;letter-spacing:1px">COT \u2014 Managed Money</span><span onclick="var k=document.getElementById(\'cot-key\');k.style.display=k.style.display===\'none\'?\'block\':\'none\'" style="font-size:9px;color:var(--td);cursor:pointer;padding:1px 5px;border:1px solid var(--bd);border-radius:3px">?</span></div>';
var mmClr=cot.mm_net>=0?'var(--g)':'var(--r)';
h+='<div style="display:flex;align-items:baseline;gap:6px"><span style="font-family:JetBrains Mono,monospace;font-size:22px;font-weight:700;color:'+mmClr+'">'+(cot.mm_net>=0?'+':'')+n(cot.mm_net)+'</span><span style="font-size:10px;color:var(--td)">net contracts</span></div>';
h+='<div style="font-size:8px;color:var(--td);margin-bottom:6px">long minus short \u2014 positive = funds betting on higher prices</div>';
var wcClr=cot.mm_weekly_change>=0?'var(--g)':'var(--r)';
h+='<div class="ctx-row"><span class="ctx-l">Weekly Change <span style="font-size:8px;color:var(--td)">(added/cut since prior wk)</span></span><span class="ctx-v" style="color:'+wcClr+'">'+(cot.mm_weekly_change>=0?'+':'')+n(cot.mm_weekly_change)+'</span></div>';
var cpClr=cot.mm_pct_52w>70?'var(--g)':cot.mm_pct_52w<30?'var(--r)':'var(--tx)';
h+='<div class="ctx-row"><span class="ctx-l">52-Week Percentile <span style="font-size:8px;color:var(--td)">(rank vs past year)</span></span><span class="ctx-v" style="color:'+cpClr+'">'+cot.mm_pct_52w.toFixed(0)+'th</span></div>';
var cRng=cot.mm_52w_high-cot.mm_52w_low;var cPos=cRng>0?((cot.mm_net-cot.mm_52w_low)/cRng*100):50;
h+='<div class="rng-bar"><div class="rng-fill" style="width:100%"></div><div class="rng-dot" style="left:'+cPos+'%"></div></div>';
h+='<div class="rng-labels"><span>'+n(cot.mm_52w_low)+'</span><span>'+n(cot.mm_52w_high)+'</span></div>';
var crwd=cot.crowding,crwdClr='var(--tm)',crwdBg='var(--sf)';
if(crwd==='EXTREMELY_LONG'){crwdClr='var(--o)';crwdBg='var(--od)'}
else if(crwd==='LONG'){crwdClr='var(--g)';crwdBg='var(--gd)'}
else if(crwd==='EXTREMELY_SHORT'){crwdClr='var(--o)';crwdBg='var(--od)'}
else if(crwd==='SHORT'){crwdClr='var(--r)';crwdBg='var(--rd)'}
h+='<div style="margin:6px 0"><span style="font-family:JetBrains Mono,monospace;font-size:9px;font-weight:700;padding:3px 8px;border-radius:3px;background:'+crwdBg+';color:'+crwdClr+';letter-spacing:1px">'+crwd.replace(/_/g,' ')+'</span></div>';
if(cot.insight)h+='<div style="font-size:10px;font-style:italic;color:var(--tm);margin-bottom:6px">'+cot.insight+'</div>';
h+='<div class="ctx-row"><span class="ctx-l">Producers/Merchants <span style="font-size:8px;color:var(--td)">(hedgers)</span></span><span class="ctx-v" style="color:'+(cot.prod_net>=0?'var(--g)':'var(--r)')+'">'+(cot.prod_net>=0?'+':'')+n(cot.prod_net)+'</span></div>';
h+='<div class="ctx-row"><span class="ctx-l">Swap Dealers <span style="font-size:8px;color:var(--td)">(banks)</span></span><span class="ctx-v" style="color:'+(cot.swap_net>=0?'var(--g)':'var(--r)')+'">'+(cot.swap_net>=0?'+':'')+n(cot.swap_net)+'</span></div>';
var cc=d.cot_context;
if(cc){h+='<div style="border-top:1px solid var(--bd);margin:8px 0 6px"></div>';
h+='<div style="font-size:9px;color:var(--td);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Since COT Report</div>';
if(cc.price_delta!==null&&cc.price_delta!==undefined){var pDClr=cc.price_delta>=0?'var(--g)':'var(--r)';
h+='<div class="ctx-row"><span class="ctx-l">Price Change</span><span class="ctx-v" style="color:'+pDClr+'">'+(cc.price_delta>=0?'+':'')+cc.price_delta.toFixed(4)+'</span></div>';}
if(cc.oi_delta!==null&&cc.oi_delta!==undefined){var oiDClr=cc.oi_delta>=0?'var(--g)':'var(--r)';
h+='<div class="ctx-row"><span class="ctx-l">OI Change</span><span class="ctx-v" style="color:'+oiDClr+'">'+(cc.oi_delta>=0?'+':'')+n(cc.oi_delta)+' contracts</span></div>';}
if(cc.interp)h+='<div style="font-size:10px;font-style:italic;color:var(--tm);margin-top:3px">\u2192 '+cc.interp+'</div>';}
h+='<div style="font-size:8px;color:var(--td);margin-top:4px;text-align:right">CFTC as of '+cot.report_date+' \u2014 updates Fridays</div>';
h+='<div id="cot-key" style="display:none;margin-top:6px;padding:8px 10px;background:var(--sf2);border-radius:4px;border:1px solid var(--bd);font-size:9px;line-height:1.7;color:var(--tm)">';
h+='<div style="font-family:JetBrains Mono,monospace;font-weight:600;color:var(--td);margin-bottom:4px;letter-spacing:1px">READING COT</div>';
h+='<div><span style="color:var(--o)">90+</span> Crowded long \u2014 everyone\u2019s in, selloffs sharp</div>';
h+='<div><span style="color:var(--g)">70\u201390</span> Well long \u2014 supported but less rally fuel</div>';
h+='<div><span style="color:var(--tx)">30\u201370</span> Neutral \u2014 no positioning signal</div>';
h+='<div><span style="color:var(--r)">10\u201330</span> Light \u2014 buying fuel on any catalyst</div>';
h+='<div><span style="color:var(--o)">&lt;10</span> Crowded short \u2014 squeeze risk</div>';
h+='<div style="border-top:1px solid var(--bd);margin:4px 0"></div>';
h+='<div><b>Prod/Merch</b> \u2014 hedgers (miners, dealers). Always short = normal</div>';
h+='<div><b>Swap Dealers</b> \u2014 banks\u2019 OTC book. Reflects client positioning</div>';
h+='<div><b>Weekly \u0394</b> \u2014 big moves (\u00b15k+) signal momentum shift</div>';
h+='<div style="border-top:1px solid var(--bd);margin:4px 0"></div>';
h+='<div><b>Since COT</b> \u2014 price/OI movement since report date:</div>';
h+='<div style="padding-left:8px">OI\u2191 + Price\u2191 = new longs entering</div>';
h+='<div style="padding-left:8px">OI\u2191 + Price\u2193 = new shorts entering</div>';
h+='<div style="padding-left:8px">OI\u2193 + Price\u2191 = shorts covering</div>';
h+='<div style="padding-left:8px">OI\u2193 + Price\u2193 = longs liquidating</div>';
h+='</div>';}
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
if(d.contract_roll){var crl=d.contract_roll,fml=crl.front_month,nml=crl.next_month;
var rlc=crl.roll_color==='red'?'var(--r)':crl.roll_color==='orange'?'var(--o)':crl.roll_color==='yellow'?'var(--y)':'var(--g)';
h+='<div style="padding:8px 10px;background:'+(crl.roll_color==='green'?'var(--gd)':crl.roll_color==='yellow'?'var(--yd)':crl.roll_color==='orange'?'var(--od)':'var(--rd)')+';border-radius:4px;border-left:3px solid '+rlc+'">';
h+='<div style="font-family:JetBrains Mono,monospace;font-size:11px;font-weight:700;color:'+rlc+'">'+crl.roll_status+'</div>';
h+='<div style="font-size:9px;color:var(--tm);margin-top:2px">'+fml.ticker+' FND: '+fml.fnd+'</div></div>';
if(crl.roll_urgency==='critical'||crl.roll_urgency==='warning'){
h+='<div style="margin-top:6px;padding:6px 10px;background:var(--rd);border-radius:4px;font-size:10px;color:var(--r)">\u26A0 Liquidity migrating to '+(nml?nml.ticker:'next contract')+' \u2014 check execution quality</div>';}
if(crl.open_interest){var oi=crl.open_interest;
h+='<div style="margin-top:10px;border-top:1px solid var(--bd);padding-top:8px">';
h+='<div style="font-size:9px;color:var(--td);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px">Open Interest</div>';
h+='<div class="ctx-row"><span class="ctx-l">Total OI</span><span class="ctx-v">'+n(oi.total)+' contracts</span></div>';
if(oi.trend){var otc=oi.trend==='building'?'var(--g)':oi.trend==='declining'?'var(--r)':'var(--tm)';
var oarr=oi.trend==='building'?'\u2191':oi.trend==='declining'?'\u2193':'\u2192';
h+='<div class="ctx-row"><span class="ctx-l">Trend</span><span class="ctx-v" style="color:'+otc+'">'+oarr+' '+oi.trend+'</span></div>';
if(oi.change_5d!==undefined)h+='<div class="ctx-row"><span class="ctx-l">'+oi.history_days+'d Change</span><span class="ctx-v" style="color:'+otc+'">'+(oi.change_5d>0?'+':'')+n(oi.change_5d)+' ('+oi.change_5d_pct+'%)</span></div>';}
h+='</div>';}
}else h+='<div class="nd">Contract data unavailable</div>';
h+='</div>';
// Signal & GTC — consolidated
h+='<div class="pn sp" id="pn-sp"><div class="pl">Signal & GTC</div>';
// Fix Window Meter
if(fw){var fwc=fw.color==='green'?'var(--g)':fw.color==='red'?'var(--r)':fw.color==='orange'?'var(--o)':'var(--y)';
h+='<div class="fw-meter"><div class="fw-header"><span class="fw-label" style="color:'+fwc+'">FIX WINDOW</span><span class="fw-score" style="color:'+fwc+'">'+fw.score+'</span></div>';
h+='<div class="fw-bar"><div class="fw-fill" style="width:'+fw.score+'%;background:'+fwc+'"></div></div>';
h+='<div style="font-family:JetBrains Mono,monospace;font-size:11px;font-weight:700;color:'+fwc+';margin-bottom:4px">'+fw.label+'</div>';
if(fw.factors&&fw.factors.length){h+='<div class="fw-factors">';fw.factors.forEach(function(f){h+='<span class="fw-tag">'+f+'</span>';});h+='</div>';}
h+='</div>';}
if(fo){var fctx=fo.fixable_count+' order'+(fo.fixable_count!==1?'s':'')+' fixable now';
if(fo.blocked_lme_count>0)fctx+=' ('+fo.blocked_lme_count+' awaiting LME)';
h+='<div class="fw-context">'+fctx+'</div>';
if(fw&&fw.score>=65&&fo.shipped_fixable&&fo.shipped_fixable.length>0){var top=fo.shipped_fixable[0];
h+='<div class="fw-nudge">'+n(Math.round(top.open_lbs||top.lbs))+' lbs shipped to '+top.consumer+' \u2014 fix now?</div>';}}
h+='<div class="sb '+s.signal_color+'">'+s.signal+'</div>';
h+='<div class="sdt">'+s.signal_detail+'</div><div style="font-size:10px;color:var(--td);margin-top:5px">'+s.move_desc+'</div>';
if(s.momentum_note)h+='<div style="font-size:10px;color:var(--p);margin-top:6px">'+s.momentum_note+'</div>';
if(s.dxy_signal&&s.dxy_signal.direction!=='flat'){var dsc=s.dxy_signal.color;h+='<div style="font-size:10px;color:var(--'+dsc+');margin-top:4px">'+s.dxy_signal.msg+'</div>';}
if(s.spread_signal){var ssc=s.spread_signal.color;h+='<div class="arb-box" style="border-left-color:var(--'+ssc+')"><div class="arb-dir" style="color:var(--'+ssc+')">'+s.spread_signal.direction+'</div><div class="arb-msg">'+s.spread_signal.msg+'</div></div>';}
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
if(cfg.fix_target)h+='<div class="tl"><span class="tll">Fix Target</span><span class="tlv">$'+cfg.fix_target.toFixed(2)+'</span></div>';
if(gtc.length>0){gtc.forEach(function(g){h+='<div class="gi '+g.urgency+'"><div class="ga '+g.urgency+'">'+g.action+'</div><div class="gd">'+g.detail+'</div></div>';});}
else h+='<div class="nd">No GTC suggestions</div>';
// Placed GTC Orders
if(gtp.length>0){
h+='<div class="gp-hdr">Placed Orders</div>';
gtp.forEach(function(o){
var hit=o.triggered;
var cls=hit?'gp-item hit':'gp-item';
var badge=hit?'<span class="gp-badge hit">HIT</span>':'<span class="gp-badge active">GTC</span>';
var dist='';
if(o.distance_mt!==null&&o.distance_mt!==undefined){
var dmt=o.distance_mt;
var dclr=dmt>=0?'var(--g)':'var(--tm)';
dist='<span class="gp-dist" style="color:'+dclr+'">'+(dmt>=0?'+':'')+n(Math.round(dmt))+'/MT</span>';
}
h+='<div class="'+cls+'" data-gtc-id="'+o.id+'">'+badge;
h+='<div class="gp-info"><div class="gp-line1">'+o.grade+' @ $'+n(o.price_mt)+'/MT</div>';
h+='<div class="gp-line2">'+o.customer+' \u2014 '+o.loads+' load'+(o.loads>1?'s':'')+'</div></div>';
h+=dist;
h+='<div class="gp-rm" onclick="removeGtc('+o.id+')" title="Remove">\u00D7</div>';
h+='</div>';
});
}
h+='<div class="gp-add-btn" onclick="toggleGtcForm()">+ Add GTC</div>';
h+='<div class="gp-form" id="gtc-form">';
h+='<div class="gp-form-row"><input id="gtc-cust" placeholder="Customer" value="OM Commodities"><select id="gtc-grade"><option>BB</option><option>#1</option><option>#2</option><option>Chops</option></select></div>';
h+='<div class="gp-form-row"><input id="gtc-price" type="number" placeholder="LME Cash $/MT"><input id="gtc-loads" type="number" placeholder="Loads" value="1" min="1"></div>';
h+='<div class="gp-form-btns"><button class="gp-save" onclick="addGtc()">Save</button><button class="gp-cancel" onclick="toggleGtcForm()">Cancel</button></div>';
h+='</div>';
h+='</div>';
// Sales Orders
h+='<div class="pn slp" id="pn-slp"><div class="pl">Sales Orders</div>';
if(r&&(r.priced_sales_lbs>0||r.unpriced_sales_lbs>0)){
var tt=r.priced_sales_lbs+r.unpriced_sales_lbs,pp=tt>0?(r.priced_sales_lbs/tt*100):0;
h+='<div class="sbar"><div class="sbp" style="width:'+pp+'%"></div><div class="sbu" style="width:'+(100-pp)+'%"></div></div>';
h+='<div class="slg"><div class="sli"><div class="sld" style="background:var(--g)"></div>Priced '+n(Math.round(r.priced_sales_lbs))+' lbs ('+pp.toFixed(0)+'%)</div>';
h+='<div class="sli"><div class="sld" style="background:var(--p)"></div>Unpriced '+n(Math.round(r.unpriced_sales_lbs))+' lbs ('+(100-pp).toFixed(0)+'%)</div></div>';
if(sched&&sched.length>0){
var unpricedSOs=new Set();
if(pos){(pos.sales_unpriced_shipped||[]).concat(pos.sales_unpriced_unshipped||[]).forEach(function(s){unpricedSOs.add(String(s.order||''));});}
h+='<div class="sh-wrap"><div class="sh-hdr">SHIP SCHEDULE</div>';
h+='<table class="sh-tbl"><tr><th>Ship</th><th>SO</th><th>Grade</th><th>Customer</th><th>Status</th></tr>';
var now=new Date();now.setHours(0,0,0,0);
sched.forEach(function(sh){
var sd=new Date(sh.ship_date+'T00:00:00');var diff=Math.round((sd-now)/86400000);
var cls=diff<=0?'sh-urgent':diff<=7?'sh-soon':'';
var isUnpriced=unpricedSOs.has(String(sh.so));
var status=isUnpriced?'<span style="color:var(--r)">UNPRICED</span>':'<span style="color:var(--g)">PRICED</span>';
var dateLabel=diff<=0?'TODAY':diff===1?'TOMORROW':sh.ship_date.substring(5);
h+='<tr class="'+cls+'"><td>'+dateLabel+'</td><td class="sh-so">'+sh.so+'</td><td>'+sh.grade+'</td><td class="sh-cust">'+sh.customer+'</td><td>'+status+'</td></tr>';
});
h+='</table></div>';}
var shipd=pos?pos.sales_unpriced_shipped:[];
var unshipd=pos?pos.sales_unpriced_unshipped:[];
var cav=m.customer_availability||{};
function soGrade(raw){var c=(raw||'').toUpperCase().replace(/\s*\(.*\)/,'');
if(/CHOP/.test(c))return'Chops';if(/CUBB/.test(c))return'BB';if(/CU1/.test(c))return'#1';if(/CU2/.test(c))return'#2';return c.replace(/^CU/,'');}
function soAvail(name){var ca=cav[name];if(!ca)return'';
return ca.available?'<span class="so-avail live" title="Available '+ca.hours+'">\u25CF</span>':'<span class="so-avail off" title="Offline \u2014 hours: '+ca.hours+'">\u25CB</span>';}
function soRow(so,cls){
return '<div class="so-row '+cls+'">'+soAvail(so.consumer)+'<span class="so-cust">'+so.consumer+'</span><span class="so-comm">'+soGrade(so.commodity)+'</span><span class="so-lbs">'+n(Math.round(so.open_lbs||so.lbs))+'</span><span class="so-basis '+(so.basis||'COMEX').toLowerCase()+'">'+(so.basis||'COMEX')+'</span></div>';}
if(shipd&&shipd.length>0){h+='<div class="so-section"><div class="so-hdr ship">\u26A0 SHIPPED \u2014 FIX PRIORITY</div>';
shipd.forEach(function(so){h+=soRow(so,'shipped');});
h+='</div>';}
if(unshipd&&unshipd.length>0){h+='<div class="so-section"><div class="so-hdr unship">UNSHIPPED \u2014 OPEN</div><div class="so-scroll">';
unshipd.forEach(function(so){h+=soRow(so,'unshipped');});
h+='</div></div>';}
if((!shipd||shipd.length===0)&&(!unshipd||unshipd.length===0)){
h+='<div style="margin-top:2px">';
if(r.sales_unpriced_shipped_lbs>0)h+='<div class="cat-row hot"><span class="cat-label">\u26A0 Unpriced / Shipped</span><span class="cat-val hot">'+n(Math.round(r.sales_unpriced_shipped_lbs))+' lbs</span></div>';
h+='<div class="cat-row ok"><span class="cat-label">Priced / Unshipped</span><span class="cat-val ok">'+n(Math.round(r.sales_priced_unshipped_lbs))+' lbs</span></div>';
h+='<div class="cat-row chill"><span class="cat-label">Unpriced / Unshipped</span><span class="cat-val chill">'+n(Math.round(r.sales_unpriced_unshipped_lbs))+' lbs</span></div>';
h+='</div>';}
if(r.priced_sales_avg>0)h+='<div class="rs" style="margin-top:6px"><span class="rsl">Avg priced</span><span class="rsv">$'+r.priced_sales_avg.toFixed(4)+'</span></div>';
}else h+='<div class="nd">No sales data</div>';
h+='</div>';
// Sales & Margin — consolidated: Sales Position + Margin
h+='<div class="pn sap" id="pn-sap"><div class="pl">Sales & Margin</div>';
if(r&&r.total_inv_po>0){
var sup=r.total_inv_po,dem=r.total_sales_lbs,mx=Math.max(sup,dem)||1;
var supW=Math.round(sup/mx*100),demW=Math.round(dem/mx*100);
var sd=r.surplus_deficit_lbs,sdCls=sd>=0?'pos':'neg',sdLbl=sd>=0?'Surplus':'Deficit';
h+='<div style="margin-bottom:10px">';
h+='<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px"><span style="color:var(--tm)">Supply (Inv + POs)</span><span style="font-family:JetBrains Mono,monospace;font-weight:600">'+n(Math.round(sup))+' lbs</span></div>';
h+='<div class="rbg"><div class="rbf" style="width:'+supW+'%;background:var(--b)"></div></div>';
h+='<div style="display:flex;justify-content:space-between;font-size:10px;margin:6px 0 3px"><span style="color:var(--tm)">Total Sales</span><span style="font-family:JetBrains Mono,monospace;font-weight:600">'+n(Math.round(dem))+' lbs</span></div>';
h+='<div class="rbg"><div class="rbf" style="width:'+demW+'%;background:var(--p)"></div></div>';
h+='</div>';
h+='<div class="rs"><span class="rsl">'+sdLbl+'</span><span class="rsv '+sdCls+'">'+n(Math.abs(Math.round(sd)))+' lbs</span></div>';
var ic=r.inv_by_commodity||{},sc=r.sales_by_commodity||{},mf=cfg.monthly_flow||{};
var tl=cfg.truckload_lbs||42000;
var cats=['BB','#1','#2','Chops'];
h+='<div style="margin-top:8px;border-top:1px solid var(--bd);padding-top:8px">';
h+='<div style="display:flex;font-size:9px;color:var(--tm);margin-bottom:4px;padding:0 2px"><span style="flex:1">Grade</span><span style="width:55px;text-align:right">Inv</span><span style="width:55px;text-align:right">Sales</span><span style="width:50px;text-align:right">Flow</span><span style="width:14px"></span></div>';
for(var ci=0;ci<cats.length;ci++){var cat=cats[ci];
var inv=ic[cat]||0,sal=sc[cat]||0,flow=mf[cat]||0;
var flowLoads=flow>0?Math.round(flow/tl):0;
var moFwd=flow>0?(sal/flow):99;
var warn=moFwd<1?'var(--r)':moFwd<2?'var(--y)':'';
var warnIcon=moFwd<1?'\u26A0':moFwd<2?'\u25CF':'';
var warnClr=moFwd<1?'var(--r)':moFwd<2?'var(--y)':'';
h+='<div style="display:flex;font-size:10px;padding:3px 2px;align-items:center;border-bottom:1px solid var(--bd)'+(warn?';background:rgba('+(moFwd<1?'255,71,87':'255,192,72')+',.06)':'')+'">';
h+='<span style="flex:1;font-weight:600">'+cat+'</span>';
h+='<span style="width:55px;text-align:right;font-family:JetBrains Mono,monospace;font-size:10px">'+n(Math.round(inv))+'</span>';
h+='<span style="width:55px;text-align:right;font-family:JetBrains Mono,monospace;font-size:10px">'+n(Math.round(sal))+'</span>';
h+='<span style="width:50px;text-align:right;font-family:JetBrains Mono,monospace;font-size:10px;color:var(--td)">'+flowLoads+'/mo</span>';
h+='<span style="width:14px;text-align:center;font-size:9px;color:'+warnClr+'">'+warnIcon+'</span>';
h+='</div>';
if(cat==='Chops'&&r.icw_cu_lbs>0){
h+='<div style="display:flex;font-size:9px;padding:2px 2px 2px 12px;color:var(--tm);border-bottom:1px solid var(--bd)">';
h+='<span style="flex:1">Still to chop</span><span style="width:55px;text-align:right;font-family:JetBrains Mono,monospace">'+n(Math.round(r.icw_cu_lbs))+'</span><span style="width:120px"></span></div>';
}}
if(r.po_lbs>0){h+='<div style="display:flex;font-size:9px;padding:4px 2px;color:var(--tm);border-bottom:1px solid var(--bd)">';
h+='<span style="flex:1">+ POs not yet received</span><span style="width:55px;text-align:right;font-family:JetBrains Mono,monospace">'+n(Math.round(r.po_lbs))+'</span><span style="width:120px"></span></div>';}
h+='</div>';
h+='<div style="border-top:1px solid var(--bd);margin:10px 0"></div>';
var mp=d.margin_projection;
if(mp){var gmCls=mp.gross_margin_per_lb>=0?'pos':'neg';
h+='<div style="display:flex;justify-content:space-between;align-items:baseline;padding:10px 0;margin-bottom:6px;border-bottom:1px solid var(--bd)"><span style="font-size:13px;font-weight:600;color:var(--tx)">Gross Margin/lb</span><span class="'+gmCls+'" style="font-family:JetBrains Mono,monospace;font-size:20px;font-weight:700">$'+mp.gross_margin_per_lb.toFixed(4)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:5px 8px;background:var(--sf2);border-radius:3px;margin-bottom:3px"><span style="font-size:10px;color:var(--td)">Avg Sell Price</span><span style="font-family:JetBrains Mono,monospace;font-size:11px;color:var(--tm)">$'+mp.avg_sell_price.toFixed(4)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:5px 8px;background:var(--sf2);border-radius:3px;margin-bottom:3px"><span style="font-size:10px;color:var(--td)">Avg Cost/lb</span><span style="font-family:JetBrains Mono,monospace;font-size:11px;color:var(--tm)">$'+mp.avg_cost.toFixed(4)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:5px 8px;background:var(--sf2);border-radius:3px;margin-bottom:3px"><span style="font-size:10px;color:var(--td)">Total Gross Margin</span><span class="'+gmCls+'" style="font-family:JetBrains Mono,monospace;font-size:11px;font-weight:600">$'+n(Math.round(mp.total_gross_margin))+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:5px 8px;background:var(--sf2);border-radius:3px"><span style="font-size:10px;color:var(--td)">Margin %</span><span class="'+gmCls+'" style="font-family:JetBrains Mono,monospace;font-size:11px;font-weight:600">'+mp.margin_pct.toFixed(1)+'%</span></div>';
}else h+='<div class="nd">Need position + market data for margin</div>';
}else h+='<div class="nd">No supply data</div>';
h+='</div>';
// Decisions — recap at bottom with jump-to-section links
h+='<div class="pn dp s2" id="pn-dp"><div class="pl">What To Do</div>';
// Broker Intel input
h+='<div class="intel-wrap"><button class="intel-toggle'+(window._intelData&&window._intelData.signals&&window._intelData.signals.length?' has-intel':'')+'" onclick="toggleIntel()">BROKER INTEL '+(window._intelData&&window._intelData.signals&&window._intelData.signals.length?'('+window._intelData.signals.length+')':'')+'</button>';
h+='<div class="intel-form" id="intel-form">';
h+='<textarea class="intel-ta" id="intel-ta" placeholder="Paste broker email headlines here...">'+(window._intelData&&window._intelData.raw?window._intelData.raw:'')+'</textarea>';
h+='<div class="intel-btns"><button class="intel-btn intel-save" onclick="saveIntel()">SAVE & ANALYZE</button><button class="intel-btn intel-clear" onclick="clearIntel()">CLEAR</button></div>';
if(window._intelData&&window._intelData.signals&&window._intelData.signals.length){
h+='<div class="intel-signals">';
window._intelData.signals.forEach(function(s){var st=s.short||'watch',lt=s.long||'watch';var sti=st==='bull'?'\uD83D\uDFE2':st==='bear'?'\uD83D\uDD34':'\u26A0';var lti=lt==='bull'?'\uD83D\uDFE2':lt==='bear'?'\uD83D\uDD34':'\u26A0';h+='<div class="intel-sig" style="font-weight:600;margin-top:6px">'+s.headline+' ['+sti+' near / '+lti+' long]</div>';h+='<div class="intel-sig" style="padding-left:12px;opacity:0.85">'+sti+' '+s.near+'</div>';h+='<div class="intel-sig" style="padding-left:12px;opacity:0.85">'+lti+' '+s.far+'</div>';});
h+='</div>';
if(window._intelData.time)h+='<div class="intel-time">Updated '+window._intelData.time+'</div>';
}
h+='</div></div>';
h+='<div class="dl">';
function decSec(t){
if(/FIX WINDOW|LIQUIDATION|FLASH|DIP|BIG.DROP|momentum/i.test(t))return 'pn-sp';
if(/SHFE|DXY|dollar|Fed:|warehouse|COMEX.*LME|parity|arb/i.test(t))return 'pn-pp';
if(/shipped.*UNPRICED|UNPRICED.*shipped/i.test(t))return 'pn-slp';
if(/TARGET|approaching|GTC/i.test(t))return 'pn-sp';
if(/COT:|Managed Money|crowded|squeeze/i.test(t))return 'pn-tp';
if(/Support|Resistance|Near-term floor|Near-term ceiling|Major support|Major resistance|breakout/i.test(t))return 'pn-tp';
if(/migrating|roll/i.test(t))return 'pn-tp';
if(/Long.*unpriced|unpriced.*long/i.test(t))return 'pn-posp';
if(/POSITION.*range|OVER MAX|UNDER FLOOR/i.test(t))return 'pn-posp';
if(/SHIPPING TODAY|Ships within/i.test(t))return 'pn-slp';
if(/pipeline.*thin|need to sell/i.test(t))return 'pn-sap';
if(/margin/i.test(t))return 'pn-sap';
if(/COMEX:.*MT|LME:.*MT|Global:/i.test(t))return 'pn-pp';
if(/^INTEL:|^INTEL_DETAIL:/i.test(t))return 'pn-dp';
return null;}
dec.forEach(function(d){
if(/^SEC:/.test(d)){var label=d.replace('SEC:','');
var scls=label==='ACT NOW'?'sec-now':label==='WATCH TODAY'?'sec-watch':'sec-ref';
h+='<div class="dec-sec '+scls+'">'+label+'</div>';return;}
var cls='di';if(d.indexOf('\u26A0')>=0||d.indexOf('UNPRICED')>=0)cls='di warn';
if(d.indexOf('\uD83D\uDFE2')>=0)cls='di fix-good';if(d.indexOf('\uD83D\uDD34')>=0)cls='di fix-bad';
var isDetail=/^INTEL_DETAIL:/.test(d);
var isHead=/^INTEL:/.test(d)&&!isDetail;
if(isDetail){cls+=' intel-detail';d=d.replace('INTEL_DETAIL: ','');}
if(isHead){cls+=' intel-head';}
var sec=decSec(d),jmp='';
if(sec&&!isDetail)jmp='<span class="di-jump" onclick="document.getElementById(\''+sec+'\').scrollIntoView({behavior:\'smooth\',block:\'start\'})" title="Jump to section">\u2191</span>';
var click=isHead?' onclick="this.classList.toggle(\'open\')"':'';
h+='<div class="'+cls+'"'+click+'><span class="di-txt">'+d+'</span>'+jmp+'</div>';});
h+='</div></div>';
$('db').innerHTML=h;
// Render mini chart strip
renderMiniCharts(m);
}
function mkSvg(el,data,color,data2,color2){
if(!el||!data||!data.length)return;
var w=el.clientWidth||80,ht=el.clientHeight||48;
// Build shared min/max from both series (skip nulls in data2)
var all=data.slice();
if(data2)data2.forEach(function(v){if(v!==null&&v!==undefined)all.push(v);});
var mn=Math.min.apply(null,all),mx=Math.max.apply(null,all),rg=mx-mn||1;
var n=data.length;
function xPos(i){return(i/(n-1))*w;}
function yPos(v){return ht-((v-mn)/rg)*(ht-4)-2;}
function pts(p){return p.map(function(v,i){return xPos(i)+','+yPos(v)}).join(' ');}
var p1=pts(data);var last1=data[data.length-1];
var ly=yPos(last1);
var up=last1>=data[0],cl=color||(up?'#00e59b':'#ff4757');
var svg='<svg viewBox="0 0 '+w+' '+ht+'" preserveAspectRatio="none">';
svg+='<defs><linearGradient id="gf'+el.id+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+cl+'" stop-opacity=".12"/><stop offset="100%" stop-color="'+cl+'" stop-opacity="0"/></linearGradient></defs>';
svg+='<polygon points="0,'+ht+' '+p1+' '+w+','+ht+'" fill="url(#gf'+el.id+')"/>';
svg+='<polyline points="'+p1+'" fill="none" stroke="'+cl+'" stroke-width="1.5" stroke-linejoin="round"/>';
svg+='<circle cx="'+w+'" cy="'+ly+'" r="2.5" fill="'+cl+'"/>';
// Second series — date-aligned, may have nulls for missing dates
if(data2&&data2.length){var cl2=color2||'#4a9eff';
// Build polyline segments skipping nulls
var segs=[],cur=[];
for(var i=0;i<data2.length;i++){
if(data2[i]!==null&&data2[i]!==undefined){cur.push(xPos(i)+','+yPos(data2[i]));}
else if(cur.length>0){segs.push(cur);cur=[];}
}
if(cur.length>0)segs.push(cur);
segs.forEach(function(seg){if(seg.length>=2)svg+='<polyline points="'+seg.join(' ')+'" fill="none" stroke="'+cl2+'" stroke-width="1.2" stroke-linejoin="round" stroke-dasharray="4,2"/>';
else if(seg.length===1)svg+='<circle cx="'+seg[0].split(',')[0]+'" cy="'+seg[0].split(',')[1]+'" r="1.5" fill="'+cl2+'"/>';});
// Endpoint dot for last non-null value
var lastIdx=-1;for(var j=data2.length-1;j>=0;j--){if(data2[j]!==null&&data2[j]!==undefined){lastIdx=j;break;}}
if(lastIdx>=0)svg+='<circle cx="'+xPos(lastIdx)+'" cy="'+yPos(data2[lastIdx])+'" r="2" fill="'+cl2+'"/>';
}
svg+='</svg>';
el.innerHTML=svg;}
function monthLabels(data,elId){
var ml=$((elId));if(!ml||!data||data.length<2)return;
var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
var seen={},labels=[];
data.forEach(function(d,i){
var dt=d.date||'';var m=parseInt(dt.substring(5,7),10)-1;
var key=dt.substring(0,7);
if(!seen[key]){seen[key]=1;labels.push({month:months[m],pos:i/(data.length-1)*100});}});
var h='';labels.forEach(function(l){h+='<span style="position:absolute;left:'+l.pos+'%">'+l.month+'</span>';});
ml.style.position='relative';ml.innerHTML=h;}
function renderMiniCharts(m){
var cxData=m.sparkline||[];
var cxPts=cxData.map(function(d){return d.close});
var lmData=m.lme_spark||[];
var cxV=$('mc-cx-v'),lmV=$('mc-lm-v'),ovEl=$('mc-overlay');
// COMEX change label
if(cxPts.length>0){
var last=cxPts[cxPts.length-1],first=cxPts[0],chg=last-first,up=chg>=0;
if(cxV)cxV.innerHTML='<span style="color:#d4845a">CX </span><span style="color:'+(up?'var(--g)':'var(--r)') +'">'+(up?'+':'')+chg.toFixed(3)+'</span>';
}
// LME change label
var lmRaw=lmData.map(function(d){return d.close});
if(lmRaw.length>=2){
var lmLast=lmRaw[lmRaw.length-1],lmFirst=lmRaw[0],lmChg=lmLast-lmFirst,lmUp=lmChg>=0;
if(lmV)lmV.innerHTML='<span style="color:#4a9eff">LME </span><span style="color:'+(lmUp?'var(--g)':'var(--r)') +'">'+(lmUp?'+':'')+lmChg.toFixed(3)+'</span>';
}
// Date-align LME to COMEX timeline
var lmByDate={};
lmData.forEach(function(d){lmByDate[d.date]=d.close;});
var lmAligned=cxData.map(function(d){return lmByDate[d.date]||null;});
// Overlay chart — both series on shared scale, date-aligned
if(ovEl&&cxPts.length>0){
mkSvg(ovEl,cxPts,'#d4845a',lmAligned,'#4a9eff');
}
monthLabels(cxData,'mc-cx-m');
}
// --- Placed GTC management ---
var _gtcNotified=new Set();
if('Notification' in window&&Notification.permission==='default'){Notification.requestPermission();}
function checkGtcAlerts(gtp){
if(!gtp||!gtp.length)return;
if('Notification' in window&&Notification.permission==='granted'){
gtp.forEach(function(o){
if(o.triggered&&!_gtcNotified.has(o.id)){
_gtcNotified.add(o.id);
new Notification('GTC HIT \u2014 '+o.grade+' @ $'+Number(o.price_mt).toLocaleString(),{
body:'LME Cash reached $'+Number(o.price_mt).toLocaleString()+'/MT \u2014 '+o.customer+' order triggered',
icon:'/logo.png',tag:'gtc-'+o.id
});
}});}}
function toggleGtcForm(){var f=$('gtc-form');if(f)f.classList.toggle('show');}
function addGtc(){
var cust=$('gtc-cust').value.trim();
var grade=$('gtc-grade').value;
var price=parseFloat($('gtc-price').value);
var loads=parseInt($('gtc-loads').value)||1;
if(!cust||!price){alert('Customer and price required');return;}
fetch('/api/gtc',{method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({action:'add',customer:cust,grade:grade,basis:'LME_CASH',price_mt:price,loads:loads})
}).then(function(r){return r.json()}).then(function(d){if(d.ok){toggleGtcForm();fd();}}).catch(function(e){console.error(e);});
}
function removeGtc(id){
if(!confirm('Remove this GTC order?'))return;
fetch('/api/gtc',{method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({action:'remove',id:id})
}).then(function(r){return r.json()}).then(function(d){if(d.ok)fd();}).catch(function(e){console.error(e);});
}
fd();setInterval(fd,60000);setInterval(syncTheme,15000);
</script>
</body>
</html>
